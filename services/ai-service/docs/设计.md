🎯 核心数据管道抽象

1. 主AI分析管道

用户: BTC@15m → bot → AI层 → 数据获取 → 指标计算 → LLM调用 → 报告生成 → 图片渲染 → Telegram发送
耗时: 15-30秒 (LLM调用占80%)

2. 技术指标管道

K线数据 → 批量读取 → 8线程并行计算 → 信号生成 → 缓存 → 输出
支持: MA/MACD/RSI/KDJ/ATR/BB/VWAP等20+

3. 多周期共振管道

基准周期(15m) → 自动推导(5m/1h/4h) → 并行计算 → 权重合成 → 共振信号
权重: 5m:20% + 15m:30% + 1h:30% + 4h:15% + 1d:5%

4. 多级缓存管道

L1内存(60秒) → L2 Redis(5分钟) → L3 SQLite(24小时) → API调用
命中率: 95% (L1+L2+L3)

用户: BTC@15m → bot → 取数据，取BTC，全部常用周期数据的k线条对应的数据 取 默认: 1m,5m,15m,1h,4h,1d,1w 每个周期50条k线数据

例如

"exchange","symbol","bucket_ts","open","high","low","close","volume","quote_volume","trade_count","is_closed","source","ingested_at","updated_at","taker_buy_volume","taker_buy_quote_volume"
binance_futures_um,BCHUSDT,2020-01-01 08:00:00.000 +0800,204.720000000000,204.720000000000,204.460000000000,204.560000000000,239.555000000000,49016.594180000000,37,true,binance_zip,2025-11-14 03:27:00.723 +0800,2025-11-14 03:27:00.723 +0800,89.258000000000,18257.065650000000

从1m和对应的物化视图取

{
market_data.candles_1m
market_data.candles_15m
market_data.candles_1d
market_data.candles_1h
market_data.candles_1w
market_data.candles_4h
market_data.candles_5m
}

# Timescale/PostgreSQL 连接串 超级权限 psql -h localhost -p 5433 -U postgres -d postgres
DATABASE_URL=postgresql://opentd:OpenTD_pass@localhost:5433/market_data

读取工具；\\wsl.localhost\Ubuntu\home\lenovo\.projects\tradecat\libs\common\utils\数据库操作工具.py
\\wsl.localhost\Ubuntu\home\lenovo\.projects\tradecat\libs\common\utils\ccxt币安永续合约工具.py

读取技术指标库

\\wsl.localhost\Ubuntu\home\lenovo\.projects\tradecat\services\data-service\data\csv\market_data.db

读取这个数据库里面全部表几十张的，全部周期的对应的币种的这个技术指标，例如这个币种的1m,5m,15m,1h,4h,1d,1w对应的全部数据

构建提示词，

吧这些分别封装为多个变量，我直接写入txt方便的那种，模块化的，可以把变量嵌入到任何位置，直接在txt里面编辑，然后合并的时候，把这个对应的变量嵌入到这个提示词里面。

发送最终提示词给llmapi处理

返回结果

txt，流式传输，先返回前几百字给用户看，完整输出后输出完整txt

---

需求文档，重构ai提示词构建器

数据源层

数据库数据计算，k线+元数据+订单薄

提示词模块化

每个类型的数据，单独嵌入一个提示词里面

例如：

k线数据类模块，放置这个模块数据的提示词如这个数据的变量在里面

然后就是K线形态模块+对应的提示词

元数据模块+对应的提示词

每个模块里面包含这个提示词和这个对应的数据变量的嵌入


---

然后按照这个标准的提示词模板结构拆分为多个模块。然后呢，每个模块是一个单独的txt方便编辑

---

数据源

k线，元数据数据库；

# Timescale/PostgreSQL 连接串 超级权限 psql -h localhost -p 5433 -U postgres -d postgres
DATABASE_URL=postgresql://opentd:OpenTD_pass@localhost:5433/market_data


技术指标数据库 \\wsl.localhost\Ubuntu\home\lenovo\.projects\tradecat\services\data-service\data\csv\market_data.db

现在每个这个系统提示词要求是这样的。

改成这个文件夹格式

然后呢，就是这个文件

呃，文件夹名称就变成这个按钮的这个显示的字样。

然后里面就是多个这个模块的这个。就是可以拓展的这种

然后文件名的命名规则是这样的。

1_*.txt

2_*.txt

n_*.txt

*=文件夹对应的模块的标识

用户: BTC@15m → bot → AI层 → 数据获取(多周期K线+metrics+全指标) → 数据收集写入json，作为后面导入的变量调用位置 → （）数据组装(各block填占位符) → 提示词拼装(模块化txt合并) → LLM调用(流式) → 报告生成 → 图片/卡片渲染(可选) → Telegram发送