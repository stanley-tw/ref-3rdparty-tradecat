# 优化项逐项验收与审计标准

为 TODO 列表的每个任务定义“验收标准”（开发自检）与“审计要点”（独立审计/安全检查）。执行完成后请在对应文档/PR 中记录结果。

## 1. 日志轮转与压缩（S）
- 验收标准
  - 轮转策略：按天轮转，保留 ≥7 天且压缩为 .gz。
  - 轮转后新日志可正常写入，无丢行或句柄泄漏。
  - 手动触发（logrotate 或内置）成功，无错误日志。
- 审计要点
  - 检查 logrotate 配置或代码内轮转参数与实际路径匹配。
  - 确认守护脚本在轮转后重新打开文件（无 stale fd）。
  - 磁盘占用趋势下降，未出现日志未压缩累积。

## 2. 安全加载 .env + 权限检查（S）
- 验收标准
  - start.sh 仅解析 KEY=VALUE 行：拒绝含空格、多个 `=`、`export`/`$(` 开头内容。
  - `.env` 权限非 600 时启动失败并提示。
  - 注入用例 `ECHO_TEST='$(whoami)'` 不被执行；环境中无意外变量。
- 审计要点
  - 审阅脚本是否完全移除 `source .env`。
  - 运行 `stat config/.env` 确认权限策略生效。
  - 负面用例触发时退出码非 0，日志包含拒绝原因。

## 3. SYMBOLS_* 正则校验（S）
- 验收标准
  - 对 `SYMBOLS_GROUP*`、`SYMBOLS_EXTRA`、`SYMBOLS_EXCLUDE` 每个值应用 `^[A-Z0-9]+USDT$`（允许小写输入但转换后校验）。
  - 发现非法值立即退出并提示具体键和值。
- 审计要点
  - 查看启动日志/单测输出有无忽略非法值的路径。
  - 样例非法输入触发失败，合法输入通过。

## 4. 时间戳比较改用 datetime（S）
- 验收标准
  - `fetch_metric` 使用 datetime 对象比较，支持 `Z`、`+00:00`、无时区三类格式。
  - 解析失败的行被跳过并记录 warning。
  - 单测覆盖混合格式，结果无重复/漏项。
- 审计要点
  - 审查代码无字符串直接比较时间戳的逻辑。
  - 查看日志，确认有解析失败的警告路径。

## 5. 代理自检与切换（M）
- 验收标准
  - 启动后 3s 内对 Binance `/ping` 进行探测；失败时清空代理或切换到 `PROXY_LIST` 首个可用。
  - 探测失败有明确日志；探测成功不显著增加启动时延（<1s 额外）。
- 审计要点
  - 断网/坏代理场景验证：启动不中断核心功能。
  - 日志包含选择/禁用代理的记录。

## 6. SQLite 连接复用（M）
- 验收标准
  - 排行榜查询默认使用 1–3 个长连（`check_same_thread=False`），连接失效可自动重建。
  - 在并发查询下，平均延迟下降（基线对比）且无“too many open files”或锁错误。
- 审计要点
  - 代码中连接获取为池/单例，而非每次新建。
  - 故障注入（kill 连接）后自动恢复。

## 7. IO/CPU 拆分执行器（M）
- 验收标准
  - 任务带类型标记，IO 走线程池，CPU 走进程池，池大小可配置。
  - CPU 密集任务在多核上可见度提升（如 CPU 使用率上升，耗时下降）。
  - 进程池交互不传递大对象，避免序列化瓶颈。
- 审计要点
  - 检查调度配置及默认值，确认类型标记覆盖主要任务。
  - 压测报告显示吞吐/延迟改善，无死锁或僵尸进程。

## 8. 批量拉 K 线 / 批量算指标（M-L）
- 验收标准
  - 抓取侧采用批次请求或批量端点，并发度受控；写库使用多值 insert/COPY。
  - 指标计算对同周期多 symbol 进行向量化处理，保留单币兜底路径。
  - 监控批量失败率，失败自动降级单币模式。
- 审计要点
  - 数据一致性回归：批量与旧路径结果一致（抽样对比）。
  - 性能基准：吞吐/CPU/带宽指标优于基线。
  - 失败降级路径实际可用。

## 9. TimescaleDB 压缩策略（M-L）
- 验收标准
  - 目标表启用 compress 属性并有 policy：热数据 30 天不压缩，30 天后自动压缩；可选 180 天删除/退役。
  - 常用时间窗查询性能无显著回退；冷数据压缩率达预期。
- 审计要点
  - 审阅 DDL 和 policy；`compressed_chunk_stats` 有数据。
  - 压缩/未压缩查询各取样一次，性能差异在可接受范围。

